name: Daily Learning Update

permissions:
  contents: write

on:
  schedule:
    # Run daily at 9:00 AM UTC (2:30 PM IST)
    - cron: '0 9 * * *'
  workflow_dispatch:  # Allow manual triggering

concurrency:
  group: daily-updates
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
      # ============================================
      # CHECKOUT REPOSITORY
      # ============================================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0
      
      # ============================================
      # SETUP PYTHON
      # ============================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # ============================================
      # PULL LATEST CHANGES (SAFETY)
      # ============================================
      - name: Pull latest changes
        run: |
          echo "ğŸ”„ Syncing with remote..."
          git pull origin main
      
      # ============================================
      # RUN AUTOMATION SCRIPTS
      # ============================================
      - name: Run activity tracker
        run: |
          echo "ğŸ“ Running activity tracker..."
          python scripts/update_activity.py
      
      - name: Run learning update
        run: |
          echo "ğŸ“š Running learning update..."
          python scripts/update_learning.py
      
      - name: Run weekly summary (Sundays only)
        run: |
          day=$(date +%u)
          if [ "$day" = "7" ]; then
            echo "ğŸ“Š Running weekly summary (Sunday)..."
            python scripts/weekly_summary.py
          else
            echo "â„¹ï¸  Skipping weekly summary (not Sunday)"
          fi
      
      # ============================================
      # COMMIT AND PUSH CHANGES
      # ============================================
      - name: Configure Git
        run: |
          git config user.name "Learning Bot"
          git config user.email "learning-bot@dev-daily-tracker.com"
      
      - name: Check for changes
        id: check_changes
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Changes detected"
          fi
      
      - name: Commit changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          DATE=$(date +%Y-%m-%d)
          echo "ğŸ“ Committing changes for $DATE..."
          git commit -m "ğŸ“š Daily learning update - $DATE"
      
      - name: Push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸš€ Pushing changes to repository..."
          git push origin main
          echo "âœ… Successfully pushed changes"
      
      - name: Summary
        run: |
          if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "âœ… Workflow completed successfully with changes"
          else
            echo "âœ… Workflow completed successfully (no changes)"
          fi
